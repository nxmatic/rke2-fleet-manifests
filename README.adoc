= RKE2 Fleet Manifests (@codebase)

This branch mirrors the `rke2/` rootlet of the monorepo. Everything here is organized so we can hydrate manifests upstream (via kpt + kustomize) before the control-plane nodes ever see them.

== Layout

* `packages/<package>/` — raw kpt packages mirrored from `incus-rke2-cluster/kpt/system/**`.
* `rendered/<package>/` — output of `kpt fn render` for each package, with an auto-generated `kustomization.yaml` per directory.
* `overlays/<cluster>/<package>/` — patch layers that reference the rendered package contents.
* `overlays/<cluster>/kustomization.yaml` — aggregates the packages that should deploy for that cluster.
* `manifests/<cluster>/kpt-XX-<package>.yaml` — deterministic YAML bundles consumed by Flux and `rke2-manifests-install`.

== Workflows

=== Sync upstream packages

[source,shell]
----
# @codebase
make sync-packages
----

Run this whenever the source packages change in `incus-rke2-cluster`.

=== Render manifests for a cluster

[source,shell]
----
# @codebase
make render            # renders the "default" cluster
./render.sh <cluster>  # explicit cluster name
----

`render.sh` performs two phases:

1. `kpt fn render` for every package (emitting into `rendered/<package>`).
2. `kustomize build overlays/<cluster>/<package>` for each package, writing `manifests/<cluster>/kpt-XX-*.yaml`.

IMPORTANT: `kpt fn render` runs containerized functions (e.g., apply-setters, render-helm-chart). Ensure Docker, nerdctl, or Podman is running. Set `KPT_FN_RUNTIME` if you rely on a non-default runtime.

Commit the generated manifests whenever you want to publish a new downstream snapshot.

=== Clean outputs

[source,shell]
----
# @codebase
make clean-rendered   # drop rendered package snapshots
make clean-manifests  # drop hydrated YAML outputs
----

Use these helpers to ensure a fresh render when debugging changes.

== Next Steps

* Expand `render.sh` once we onboard more clusters.
* Customize `overlays/<cluster>/<package>` with setters or patches per environment.
* Add CI to verify `kustomize build overlays/<cluster>/<package>` matches committed YAML.

version = 1

[hook]
  on-activate = """
    if [ -d "${FLOX_ENV_PROJECT}/.github" ]; then
      remote=$(git -C "${FLOX_ENV_PROJECT}" remote get-url origin 2>/dev/null || true)
      if [ -n "${remote}" ]; then
        remote_host="github.com"
        case "${remote}" in
          git@*:* )
            remote_host=$(printf '%s' "${remote}" | cut -d'@' -f 2 | cut -d':' -f 1)
            ;;
          http://*|https://*)
            remote_host=$(printf '%s' "${remote}" | cut -d'/' -f 3)
            ;;
          ssh://*)
            remote_host=$(printf '%s' "${remote}" | cut -d'/' -f 3 | cut -d':' -f 1)
            ;;
        esac
    
        if [ -n "${GH_TOKEN:-}" ] && ! gh auth status --hostname "${remote_host}" >/dev/null 2>&1; then
          echo "Detected GH_TOKEN, logging in gh for ${remote_host}..." >&2
          printf '%s' "${GH_TOKEN}" | gh auth login --with-token --hostname "${remote_host}" >/dev/null 2>&1 || true
        fi
    
        if gh auth status --hostname "${remote_host}" >/dev/null 2>&1; then
          gh auth setup-git --hostname "${remote_host}" >/dev/null 2>&1 || true
        fi
      fi
    fi
  """

[include]
  [[include.environments]]
    dir = '/var/lib/git/nxmatic/fleet/flox/keyhole'

[install]
  [install.gh]
    pkg-group = 'git'
    pkg-path = 'gh'

  [install.git]
    pkg-group = 'git'
    pkg-path = 'git'

  [install.git-town]
    pkg-group = 'git'
    pkg-path = 'git-town'

  [install.gitflow]
    pkg-group = 'git'
    pkg-path = 'gitflow'

[options]

[profile]
  common = """
    if [ -d "${FLOX_ENV_PROJECT}/.github" ]; then
      gh_login=""
      if [ -n "${GH_TOKEN:-}" ]; then
        gh_login=$(gh api user --jq '.login' 2>/dev/null || true)
      elif command -v pass >/dev/null 2>&1; then
        gh_secret=$(pass show coding/github@work 2>/dev/null | head -n 1 || true)
        if [ -n "${gh_secret}" ]; then
          gh_login=$(env GH_TOKEN="${gh_secret}" gh api user --jq '.login' 2>/dev/null || true)
        fi
      fi
      if [ -n "${gh_login}" ]; then
        remote=$(git -C "${FLOX_ENV_PROJECT}" remote get-url origin 2>/dev/null || true)
        if [ -n "${remote}" ]; then
          owner=$(printf '%s' "${remote}" | cut -d'/' -f 4)
          repo_name=$(printf '%s' "${remote}" | cut -d'/' -f 5 | cut -d'.' -f 1)
          export GITHUB_LOGIN="${gh_login}"
          export GITHUB_OWNER="${owner}"
          export GITHUB_REPOSITORY="${owner}/${repo_name}"
        fi
      fi
    fi
  """

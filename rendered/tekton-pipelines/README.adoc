== Tekton Pipelines kpt Package

This package embeds the Tekton Pipelines Helm chart via the
`+render-helm-chart+` function. The default `+tekton-setters.yaml+`
carries sample values only; copy this package per cluster and override
the setters before rendering.

=== Workflow

[arabic]
. *Fetch the package into the downstream/state repo* so every cluster keeps its own copy of the setters and rendered payloads.
+
@codebase
[source,bash]
----
kpt pkg get https://github.com/nxmatic/incus-rke2-cluster.git/kpt/system/tekton-pipelines \
    packagevariants/bioskop/system/tekton-pipelines
----
. *Edit static setters for the cluster*: update `+tekton-setters.yaml+` with the namespace, release name, service account, and any other non-secret chart options. Sensitive values come from runtime environment variables instead of the repo.
. *Render into the state tree*
+
@codebase
[source,bash]
----
kpt fn render packagevariants/bioskop/system/tekton-pipelines --output ../../state/packagevariants/bioskop/system/tekton-pipelines
----
. *Commit the rendered output*. `rke2-kpt-package-sync.service` mirrors this copy onto the control-plane host, and `rke2-tekton-pipelines.service` immediately runs `rke2-kpt-deploy` so Tekton comes online before Flux.

=== Runtime Setters

The systemd unit passes secret setters through environment variables generated during cloud-init. Override these variables in the Incus profile (or the downstream repo’s `cloud-config`) when the defaults are insufficient:

* `TEKTON_GIT_USERNAME` – defaults to `CLUSTER_GITHUB_USERNAME` or `x-access-token`.
* `TEKTON_GIT_PASSWORD` – defaults to `CLUSTER_GITHUB_TOKEN`.
* `TEKTON_GIT_URL` – defaults to `https://${CLUSTER_GITHUB_HOST:-github.com}`.
* `TEKTON_DOCKER_CONFIG_JSON` – defaults to `CLUSTER_DOCKER_CONFIG_JSON` (base64 JSON for `config.json`).
* `TEKTON_DOCKER_REGISTRY_URL` – defaults to `https://index.docker.io/v1/` unless `CLUSTER_DOCKER_REGISTRY_URL` overrides it.

Because the secrets never land in Git, the downstream repository can remain SOPS-free for this package. All runtime overrides stay in the control-plane environment file managed by `rke2-install-pre`.
